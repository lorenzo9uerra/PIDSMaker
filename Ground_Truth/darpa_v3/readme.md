# Ground Truth
## Generating process
The ground truth files are generated by following steps:
1. Determine attack time window and search all events in the time window from database
2. Determine determining malicious features from official doc
   - Determining malicious features refer to the features that can directly determine malicious nodes. 
   That is, if a node contains a determining feature, it is a malicious node.
   - For example, an IP described as malicious in the official doc is a determining feature. Netflow nodes
   whose source or destination address is the malicious IP are malicious nodes.
3. Determine suspicious malicious features from official doc
   - A suspicious malicious feature indicates that nodes with it ***maybe*** malicious.
   - For example, in a firefox exploiting attack, each node whose path or cmd line contains `firefox` 
   maybe malicious.
4. Determine malicious nodes, suspicious nodes and relevant nodes
   - Nodes having determining features and at least 1 event in the attack time window are labelled as
   malicious nodes.
   - Nodes having suspicious features and at least 1 event and connecting to a malicious node are labelled
   as malicious nodes.
   - Nodes having suspicious features and at least 1 event but not connecting to a malicious node are labelled
   as suspicious nodes.
   - Nodes not having any determining or suspicious features but connecting to a malicious or suspicious node
   are labelled as relevant nodes.
5. The information and behaviors of suspicious and relevant nodes are saved into files.
6. Manually check whether those suspicious and relevant nodes are malicious.
7. The set of malicious nodes determined in step 4 and 6 are the final malicious node set.
8. All events happening in attack time window and related with a malicious node are malicious events.

The information and behaviors of suspicious and relevant nodes are saved in `./Intermediate/dataset_name/attack_name/`.
The structure of the csv file is like:

| suspicious_node | manual_label | info | operation | relevant_node | relevant_type | relevant_info |
| -------- |-------| -------- | -------- | -------- | -------- | -------- |
| 282485 | 0     | Subject{'path': '/home/admin/Downloads/firefox/firefox', 'cmd': '/usr/bin/firefox'} | EVENT_READ | 651873 | unknown | File{'path': '/proc/6150/stat'} |

The csv files contains all behaviors of suspicious or relevant nodes in the time window. We can manually
check their behaviors and determine whether they are malicious nodes.
If a node is considered as malicious we modify `manual_label` to `1`.

### Request for comment
We can 1) use malicious node list from step 4 directly as new ground truth; or 2) check all
suspicious and relevant node manually and use malicious node list from step 7 as new ground truth.

Scheme 1) has a reasonable number of malicious nodes (55, 58 and 1 for 3 attacks in THEIA_E3 
respectively). However, this does not guarantee the integrity of the label or the absence of
isolated malicious nodes. Some suspicious nodes don't connect to malicious nodes but should be 
labelled as malicious. 

Scheme 2) guarantee the integrity of the label and the absence of isolated malicious nodes.
But the workload of manually checking is extremely huge. There are hundreds to thousands of suspicious nodes 
and tens of thousands of relevant nodes to be checked. Note that the number of relative events is 
even hundreds times of the number of nodes to be checked. 

I don't think it's feasible to manually inspect these nodes. 
Perhaps we have to accept incomplete labels and the existence of isolated malicious nodes.

## THEIA_E3
There 4 attacks in THEIA_E3 but the `Phishing E-mail Link` doesn't contain system behaviour. So we only
take the other 3 into consideration.

### Firefox_Backdoor_Drakon_In_Memory
There `55` malicious nodes (determined in step 4), `290` suspicious nodes and `4107` relevant nodes
to be checked manually.

No particular problem.

### Browser_Extension_Drakon_Dropper
There `58` malicious nodes (determined in step 4), `2436` suspicious nodes and `29884` relevant nodes
to be checked manually.

#### Problem 1: firefox nodes and scanning nodes
The attack was conducted by exploiting a firefox extension vulnerability. The attacker injected malicious
files (`/var/log/xdev`, `/var/log/wdev` and `/var/log/mail`) into the host through 8 malicious IPs. And then 
the malicious files were run and a host scanning was conducted.

All `firefox` nodes associated with 8 malicious IPs, 3 malicious files, and 9 scanned IPs
should be labelled as malicious nodes. 
But this means that we need to manually inspect 2436 suspicious nodes and 92570 associated events.
Otherwise we have to accept the incompleteness of malicious `firefox` nodes.

In addition, all netflow nodes caused by scanning should also be malicious nodes too. 
But that would make our number of malicious nodes much larger.

### Phishing_E_mail_Executable_Attachment
There are `1` malicious node, `266` suspicious nodes and `96` relevant nodes.

#### Problem 2: isolated malicious node
The attacker sent an email with a malicious attachment to the target host through the mail server.
The malicious email is received by `thunderbrid` and a malicious file `tcexec` is implanted into the host.
The attacker then tries to run `tcexec`, but fails due to a missing library.

The malicious IP (email server) connects to `thunderbrid` but not directly to `tcexec`, 
but no `thunderbrid` process that connects directly to `tcexec` was found.
`tcexec` failed to run so there is no child process.
At the end, `tcexec` becomes an isolated malicious node.

## THEIA_E5
There are 2 attacks on THEIA_E5, but we only consider the successful one `THEIA_1_Firefox_Drakon_APT_BinFmt_Elevate_Inject`.

There are `18` malicious nodes, `1353` suspicious nodes and `1574` relevant nodes.

Malicious nodes are even less than that in old kairos++ ground truth. The reason is that most `\run\shm\*`
file nodes are filtered out except `\run\shm\lc` which connected to malicious IP `208.203.20.42`. 

## CADETS_E5
The attackers conducted 2 Nginx exploiting on May 16 and 17.

### Nginx_Drakon_APT
There are `12` malicious nodes, `121` suspicious nodes and `120` relevant nodes in the attack on 
May 16.

### Nginx_Drakon_APT_17
There are `38` malicious, `487` suspicious and `428` relevant nodes in the May 17 attack.

#### Problem 3: Incompleteness due to missing features
The Cadets dataset has significant feature missing. No subject nodes don't have `path` and 
`cmd` is brief without any parameter. And many file nodes don't have `path`.

We filtered out many `whoami`, `hostsname`, `getpid` and `cat` nodes. Attackers used these
commands but we can not find these nodes connecting to determining malicious nodes. And we
don't have enough information to determining which nodes with these commands are malicious
because of the missing feature.

## CADETS_E3
There are 5 attacks in CADETS_E5. Attackers tried to exploit Nginx Backdoor on April 6, 11,
12 and 13. 
And on April 15, they tried to use cadets host as an email server to send malicious emails to
other hosts. But this is web only so I ignored it.

There is no specific problem with CADETS_E3. But same as CADETS_E5, it suffers from missing 
feature problem (Problem 3 above).

### Nginx_Backdoor_06
There are `7` malicious nodes, `3` suspicious nodes and `24` relevant nodes.

### Nginx_Backdoor_11
There are `4` malicious nodes, `12` suspicious nodes and `119` relevant nodes.

### Nginx_Backdoor_12
There are `15` malicious nodes, `3` suspicious nodes and `21` relevant nodes.

### Nginx_Backdoor_13
There are `9` malicious nodes, `19` suspicious nodes and `151` relevant nodes.




   